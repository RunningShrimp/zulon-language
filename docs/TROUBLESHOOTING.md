# ZULON Compiler - Troubleshooting Guide

Common issues and solutions when working with the ZULON compiler.

## Table of Contents

1. [Parse Errors](#parse-errors)
2. [Type Errors](#type-errors)
3. [Link Errors](#link-errors)
4. [Runtime Issues](#runtime-issues)
5. [Known Limitations](#known-limitations)
6. [Getting Help](#getting-help)

---

## Parse Errors

### "unexpected token in expression"

This is a general parsing error. Check for:

#### Missing Commas in Match Expressions

**Problem**:
```zulon
let x = match value {
    1 => "one"
    2 => "two"  // ❌ Missing comma
    _ => "other"
};
```

**Solution**:
```zulon
let x = match value {
    1 => "one",
    2 => "two",  // ✅ Add comma
    _ => "other"
};
```

**Note**: The last match arm doesn't need a comma.

#### Semicolon After Defer Statement

**Problem**:
```zulon
defer println("cleanup");  // ❌ Semicolon not allowed
```

**Solution**:
```zulon
defer println("cleanup")   // ✅ Remove semicolon
```

**Why**: Defer statements use a special parsing rule that doesn't expect a semicolon.

#### Template String Interpolation

**Problem**:
```zulon
let name = "ZULON";
let greeting = `Hello, ${name}`;  // ❌ Not supported
```

**Solution**: Use only static strings:
```zulon
let greeting = `Hello, World`;  // ✅ Static only
```

**Status**: Template interpolation is planned but not yet implemented.

### "Expected: Comma, Found: ..."

This error occurs in match expressions when arm syntax is incorrect.

**Problem**:
```zulon
match x {
    1 => {
        println("one")
    }  // ❌ Missing comma after block
    2 => "two"
}
```

**Solution**:
```zulon
match x {
    1 => {
        println("one")
    },  // ✅ Add comma
    2 => "two"
}
```

### "unexpected token: Some(LeftBrace)"

This usually indicates:

1. Template string interpolation (see above)
2. Incorrect match syntax
3. Defer block parsing issue

**For defer blocks**: Currently only single-expression defer is supported:
```zulon
// ❌ Multi-statement blocks not working yet
defer {
    println("cleanup 1");
    println("cleanup 2");
}

// ✅ Use multiple defer statements instead
defer println("cleanup 1")
defer println("cleanup 2")
```

---

## Type Errors

### "cannot find value in this scope"

**Problem**:
```zulon
fn main() -> i32 {
    println(x);  // ❌ x not declared
}
```

**Solution**: Declare the variable first:
```zulon
fn main() -> i32 {
    let x = 42;
    println(x);  // ✅ x is now in scope
}
```

**For extern functions**: Declare them before use:
```zulon
extern fn println(s: string);

fn main() -> i32 {
    println("Hello");  // ✅ println is declared
}
```

### "cannot call non-function type"

**Problem**:
```zulon
enum Option {
    Some(i32),
    None,
}

fn main() -> i32 {
    let result = Option::Some(42);  // ❌ May fail in some contexts
    0
}
```

**Issue**: Enum variant construction has type checker limitations in some contexts.

**Workaround**: This is being worked on. For now, use simpler patterns or avoid enum construction in certain contexts.

### "type mismatch"

**Problem**:
```zulon
let x: i32 = "hello";  // ❌ Type mismatch
```

**Solution**: Ensure types match:
```zulon
let x: i32 = 42;  // ✅ Correct type
```

**Note**: Type inference is limited, so you may need explicit type annotations:
```zulon
let result = if condition {
    42i32  // ✅ Explicit type
} else {
    0i32
};
```

---

## Link Errors

### "Undefined symbols for architecture arm64"

**Problem**:
```
ld: symbol(s) not found for architecture arm64
  "_println", referenced from:
      _main in example.o
clang: error: linker command failed
```

**Cause**: Extern functions (println, print_int, etc.) are declared but not implemented.

**Solutions**:

1. **View LLVM IR** (compiler did its job):
```bash
cargo run -p zulon-compiler -- example.zl
cat example.ll  # ✅ View the generated IR
```

2. **Provide C implementations**:
```c
// printf.c
#include <stdio.h>

void println(const char* s) {
    printf("%s\n", s);
}

void print_int(int n) {
    printf("%d\n", n);
}
```

3. **Compile and link**:
```bash
# Compile ZULON program
cargo run -p zulon-compiler -- example.zl

# Compile to assembly
llc example.ll -o example.s

# Compile C implementations
clang -c printf.c -o printf.o

# Link everything
clang example.s printf.o -o example

# Run
./example
```

### "llc failed" errors

**Problem**: LLVM IR compilation fails.

**Solution**: Check the LLVM IR for issues:
```bash
cargo run -p zulon-compiler -- example.zl --keep-intermediates
cat example.ll  # Look for obvious issues
```

**Common causes**:
1. Invalid LLVM IR generated by compiler (report as bug)
2. LLVM version mismatch (need LLVM 15+)
3. Corrupted intermediate files (delete and recompile)

---

## Runtime Issues

### Program Compiles But Doesn't Run

**Check**: Did you actually create an executable?

```bash
# The compiler stops at LLVM IR generation
cargo run -p zulon-compiler -- example.zl

# This only creates example.ll, not a runnable executable
# You need to manually compile and link (see Link Errors above)
```

### Unexpected Output

**Problem**: Defer statements not executing in expected order.

**Remember**: Defers execute in **LIFO** (Last In, First Out) order:
```zulon
fn main() -> i32 {
    defer println("first")   // Registered first, executes LAST
    defer println("second")  // Registered second, executes SECOND
    defer println("third")   // Registered last, executes FIRST

    0
}
// Output: third, second, first
```

### Tuples Returning Wrong Values

**Problem**: Multi-element tuple construction has limitations.

```zulon
let tuple = (1, 2, 3);
// May only get first element (1) due to MIR limitations
```

**Workaround**: Use single-element tuples or direct field access:
```zulon
let x = 1;
let y = 2;
let z = 3;

// Or use struct when available (future feature)
```

---

## Known Limitations

These are not bugs, but features not yet implemented:

### 1. Template String Interpolation
```zulon
// ❌ Not supported yet
let greeting = `Hello, ${name}`;

// ✅ Use static strings
let greeting = `Hello, World`;
```

### 2. Defer Early Return Handling
```zulon
fn example() -> i32 {
    defer println("cleanup")

    if condition {
        return 0;  // ❌ defer may not execute
    }

    0
}
```

**Current behavior**: Defer only executes at normal block exit.

### 3. For Loops
```zulon
// ❌ Not supported yet
for i in 0..10 {
    println(i);
}

// ✅ Use while loop
let i = 0;
while i < 10 {
    println(i);
    let i = i + 1;
}
```

### 4. Generic Type Instantiation
```zulon
enum Option<T> {
    Some(T),
    None,
}

// ❌ Parser supports but type checker incomplete
let result = Option::<i32>::Some(42);
```

### 5. Enum Variant Construction
```zulon
enum Option {
    Some(i32),
    None,
}

// ⚠️ Works in some contexts, fails in others
let x = Option::Some(42);
```

---

## Debugging Tips

### Enable Verbose Output

```bash
# View compilation stages
cargo run -p zulon-compiler -- example.zl

# Keep intermediate files
cargo run -p zulon-compiler -- example.zl --keep-intermediates

# View all stages
ls example.*  # .zl, .ll, .s, etc.
```

### Inspect LLVM IR

```bash
# Generate IR
cargo run -p zulon-compiler -- example.zl

# View IR
cat example.ll

# Look for:
# - Function definitions
# - Type declarations
# - Instruction sequences
```

### Test with Minimal Examples

If you encounter an error, create a minimal reproduction:

```zulon
// Start with something that works
extern fn println(s: string);

fn main() -> i32 {
    println("test");
    0
}

// Then add complexity gradually
// to isolate the issue
```

### Check Examples

The `examples/` directory contains working code:
```bash
ls examples/*.zl
cargo run -p zulon-compiler -- examples/hello_world.zl
```

---

## Reporting Bugs

When reporting bugs, include:

1. **Minimal reproduction code**
2. **Error message** (full output)
3. **Compiler version**
4. **Platform** (OS, architecture)
5. **LLVM version**

### Good Bug Report

```
**Title**: Parse error with match expression and blocks

**Code**:
```zulon
fn main() -> i32 {
    let x = match 1 {
        1 => {
            println("one")
            1
        }
        2 => "two"
        _ => "other"
    };
    0
}
```

**Error**:
```
Parse error: example.zl:5:10 to 6:10
  Expected: Comma
  Found: IntLiteral("2")
```

**Expected**: Should parse successfully

**Compiler**: v0.1.0
**Platform**: macOS arm64
```

---

## Getting Help

### Documentation

- [Getting Started Guide](GETTING_STARTED.md)
- [Language Reference](LANGUAGE_REFERENCE.md)
- [Examples](../examples/README_EN.md)

### Community

- **GitHub Issues**: https://github.com/zulon-lang/zulon/issues
- **Discord**: [Join our server](https://discord.gg/zulon)
- **Discussions**: https://github.com/zulon-lang/zulon/discussions

### Development

- **Implementation Plan**: ../IMPLEMENTATION_PLAN.md
- **Todo List**: ../TODOLIST.md
- **Ralph Loop**: ../.claude/ralph-loop.local.md

---

## Common Workflows

### Compile and Inspect

```bash
# 1. Compile
cargo run -p zulon-compiler -- example.zl

# 2. Check for errors
# (if errors, fix them)

# 3. Inspect LLVM IR
cat example.ll

# 4. If IR looks good, proceed to executable
llc example.ll -o example.s
clang example.s -o example
```

### Test a Feature

```bash
# 1. Create minimal test file
echo 'fn main() -> i32 { 0 }' > test.zl

# 2. Try to compile
cargo run -p zulon-compiler -- test.zl

# 3. Add complexity incrementally
# 4. Identify where it breaks
```

### Compare with Working Examples

```bash
# When stuck, check similar working code
cargo run -p zulon-compiler -- examples/hello_world.zl

# Compare your code with the example
# Look for differences in syntax
```

---

**Last Updated**: January 2026

**Remember**: ZULON is under active development. Many limitations are temporary and will be addressed in future releases. Check the implementation plan for upcoming features!
